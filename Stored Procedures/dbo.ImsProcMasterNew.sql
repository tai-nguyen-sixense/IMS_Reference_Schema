SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

-- =============================================
-- Author:		Vincent Morisseau
-- Create date: 2017-11-17
-- Description:	Return master in json format when user creates a new master
-- InPut:		@Id = Master.Id, @masterJson= default master in json format, @UserId = Loggged User Id
-- OutPut:		master in json format nvarchar(max) or error in string format
-- Error:		in case of error, the details are logged in Files\log folder
-- =============================================

CREATE PROCEDURE [dbo].[ImsProcMasterNew] @Id uniqueidentifier,@masterJson nvarchar(max), @UserId uniqueidentifier
	
AS
BEGIN

	Declare @returnMasterJson as nvarchar(max);
    
	BEGIN TRY  
		SET @returnMasterJson=@masterJson;
        -- @masterJson is something like 
		--  {"comments":null,"time":null,"assetComponents":[{"included":true,"id":"94d3cdd4-82ef-44f7-afd1-7c6a91805131","name":"Decks","number":null,"fullName":"Decks","fullPath":["Decks"]},{"included":true,"id":"4607e07f-1a5e-4a3c-b70e-ccafe81d6933","name":"Decks > Wearing surface","number":null,"fullName":"Decks >> Decks > Wearing surface","fullPath":["Decks","Decks > Wearing surface"]},{"included":true,"id":"983790f0-dd9b-4ffb-abb9-d5c476a4cc6e","name":"Decks > Deck top","number":null,"fullName":"Decks >> Decks > Deck top","fullPath":["Decks","Decks > Deck top"]},{"included":true,"id":"8dacd77a-29d9-4665-a7c1-32bef9a8f13f","name":"Decks > Soffit - Thin Slab","number":null,"fullName":"Decks >> Decks > Soffit - Thin Slab","fullPath":["Decks","Decks > Soffit - Thin Slab"]},{"included":true,"id":"62411211-e040-47a5-8c67-7bf4a4fbbf0f","name":"Decks > Soffit - Thin Slab","number":null,"fullName":"Decks >> Decks > Soffit - Thin Slab","fullPath":["Decks","Decks > Soffit - Thin Slab"]},{"included":true,"id":"ecfc3e27-8140-46e1-9433-9a82a82d8530","name":"Decks > Soffit - Thin Slab","number":null,"fullName":"Decks >> Decks > Soffit - Thin Slab","fullPath":["Decks","Decks > Soffit - Thin Slab"]},{"included":true,"id":"ea24bb8a-928b-45b1-b90a-a122f22bb7f3","name":"Approaches","number":null,"fullName":"Approaches","fullPath":["Approaches"]},{"included":true,"id":"ccce63fb-9917-4597-b561-08fa83fcfeb7","name":"Approaches > Wearing surface","number":null,"fullName":"Approaches >> Approaches > Wearing surface","fullPath":["Approaches","Approaches > Wearing surface"]},{"included":true,"id":"c9709a0c-7f0f-4314-8297-e0cb9f5bdd7d","name":"Joints","number":null,"fullName":"Joints","fullPath":["Joints"]},{"included":true,"id":"80beee55-70db-446c-abbc-782a1427b42e","name":"Joints > Armoring/retaining devices","number":null,"fullName":"Joints >> Joints > Armoring/retaining devices","fullPath":["Joints","Joints > Armoring/retaining devices"]},{"included":true,"id":"84167612-28c7-4a65-83ca-fdde6d7646d6","name":"Joints > Concrete end dams","number":null,"fullName":"Joints >> Joints > Concrete end dams","fullPath":["Joints","Joints > Concrete end dams"]},{"included":true,"id":"7f5cd234-e4cd-4802-b271-5dc3e204b040","name":"Joints > Seals/sealants","number":null,"fullName":"Joints >> Joints > Seals/sealants","fullPath":["Joints","Joints > Seals/sealants"]},{"included":true,"id":"689092f9-4db9-41fb-a77f-46238ee6cd97","name":"Barriers","number":null,"fullName":"Barriers","fullPath":["Barriers"]},{"included":true,"id":"e70e5952-e642-474f-ac8a-1acfdcc9b740","name":"Barriers > Barrier/Parapet Walls","number":null,"fullName":"Barriers >> Barriers > Barrier/Parapet Walls","fullPath":["Barriers","Barriers > Barrier/Parapet Walls"]},{"included":true,"id":"80742c48-1e5f-450d-b06b-99c5322bd165","name":"Barriers > Barrier/Parapet Walls","number":null,"fullName":"Barriers >> Barriers > Barrier/Parapet Walls","fullPath":["Barriers","Barriers > Barrier/Parapet Walls"]},{"included":true,"id":"a035de75-fd9c-4331-8a18-a20f7dc5f7e6","name":"Coatings","number":null,"fullName":"Coatings","fullPath":["Coatings"]},{"included":true,"id":"03362721-26fb-4f01-96e2-4c471fd90875","name":"Coatings > Structural Steel","number":null,"fullName":"Coatings >> Coatings > Structural Steel","fullPath":["Coatings","Coatings > Structural Steel"]},{"included":true,"id":"0562cc70-38f1-4841-8351-8847ac6541f2","name":"Coatings > Structural Steel","number":null,"fullName":"Coatings >> Coatings > Structural Steel","fullPath":["Coatings","Coatings > Structural Steel"]},{"included":true,"id":"a650c4b9-338b-4dbc-a380-4ae8737a394b","name":"Beams/MLE's","number":null,"fullName":"Beams/MLE's","fullPath":["Beams/MLE's"]},{"included":true,"id":"08284ebd-6ceb-4fdf-9571-28669056bce9","name":"Beams/MLE's > Girders","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Girders","fullPath":["Beams/MLE's","Beams/MLE's > Girders"]},{"included":true,"id":"62a50498-6587-49e2-ad06-8643eb579236","name":"Beams/MLE's > Girders","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Girders","fullPath":["Beams/MLE's","Beams/MLE's > Girders"]},{"included":true,"id":"7eebfabf-ff69-4b26-9830-3297d2fe9d37","name":"Beams/MLE's > Diaphragms","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Diaphragms","fullPath":["Beams/MLE's","Beams/MLE's > Diaphragms"]},{"included":true,"id":"358eae49-09cc-46b3-aed8-4adf1dd2f897","name":"Beams/MLE's > Diaphragms","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Diaphragms","fullPath":["Beams/MLE's","Beams/MLE's > Diaphragms"]},{"included":true,"id":"15951a57-6e6b-4ff7-8998-df2d3f2dd216","name":"Abutments","number":null,"fullName":"Abutments","fullPath":["Abutments"]},{"included":true,"id":"e47939fc-e3e9-4499-9b16-cb9900f42983","name":"Abutments > Abutment walls","number":null,"fullName":"Abutments >> Abutments > Abutment walls","fullPath":["Abutments","Abutments > Abutment walls"]},{"included":true,"id":"040765f8-9944-4bee-a934-386f62c405ac","name":"Abutments > Ballast walls","number":null,"fullName":"Abutments >> Abutments > Ballast walls","fullPath":["Abutments","Abutments > Ballast walls"]},{"included":true,"id":"7d6717be-269a-4a3e-8d73-997a32e7fad1","name":"Abutments > Bearings","number":null,"fullName":"Abutments >> Abutments > Bearings","fullPath":["Abutments","Abutments > Bearings"]},{"included":true,"id":"12c02b52-5a5b-4ccc-8de2-aa1a4dd9ac11","name":"Piers","number":null,"fullName":"Piers","fullPath":["Piers"]},{"included":true,"id":"103e2e7e-40cb-4c40-a6a3-416d2df1e583","name":"Piers > Shafts/columns/Pile Bents","number":null,"fullName":"Piers >> Piers > Shafts/columns/Pile Bents","fullPath":["Piers","Piers > Shafts/columns/Pile Bents"]},{"included":true,"id":"03f06642-362b-43c5-9592-08e7d556976f","name":"Piers > Caps","number":null,"fullName":"Piers >> Piers > Caps","fullPath":["Piers","Piers > Caps"]},{"included":true,"id":"a35bfb5e-0ef4-4bf9-b8d9-3e5a33858025","name":"Piers > Bearings","number":null,"fullName":"Piers >> Piers > Bearings","fullPath":["Piers","Piers > Bearings"]},{"included":true,"id":"3ced1a4b-b887-4b23-b40f-414c2c2834b1","name":"Retaining Walls","number":null,"fullName":"Retaining Walls","fullPath":["Retaining Walls"]},{"included":true,"id":"fbadcd05-3cd9-4e05-8ec2-b0b62ef6b444","name":"Retaining walls > Walls","number":null,"fullName":"Retaining Walls >> Retaining walls > Walls","fullPath":["Retaining Walls","Retaining walls > Walls"]},{"included":true,"id":"f7a16d82-f9f3-41ea-94f9-365101c0d807","name":"Foundations","number":null,"fullName":"Foundations","fullPath":["Foundations"]},{"included":true,"id":"a5f6f0fa-b756-4207-b9cb-5da3b7e36af8","name":"Foundations > Foundation (below ground level)","number":null,"fullName":"Foundations >> Foundations > Foundation (below ground level)","fullPath":["Foundations","Foundations > Foundation (below ground level)"]},{"included":true,"id":"dd7d9e08-cebd-4672-a570-659e0b180019","name":"Embankments & Streams","number":null,"fullName":"Embankments & Streams","fullPath":["Embankments & Streams"]},{"included":true,"id":"980e3fb6-f70c-4c65-9b50-79423c749f70","name":"Embankments & Streams > Embankments","number":null,"fullName":"Embankments & Streams >> Embankments & Streams > Embankments","fullPath":["Embankments & Streams","Embankments & Streams > Embankments"]},{"included":true,"id":"8a9491c9-5d3f-4971-81ae-8ee65bb6213a","name":"Embankments & Streams > Slope protection","number":null,"fullName":"Embankments & Streams >> Embankments & Streams > Slope protection","fullPath":["Embankments & Streams","Embankments & Streams > Slope protection"]},{"included":true,"id":"a4542cda-6c25-438d-87b7-e37162be5649","name":"Span Total","number":null,"fullName":"Span Total","fullPath":["Span Total"]},{"included":true,"id":"06d5507e-e16a-4034-ad0c-b67eeecfa232","name":"Span 1","number":null,"fullName":"Span Total >> Span 1","fullPath":["Span Total","Span 1"]},{"included":true,"id":"38b156e0-40d5-4f61-a589-f5d7873b7996","name":"Span 2","number":null,"fullName":"Span Total >> Span 2","fullPath":["Span Total","Span 2"]},{"included":true,"id":"19d04985-9ea4-4b11-aa8f-2eaf315d683c","name":"Span 3","number":null,"fullName":"Span Total >> Span 3","fullPath":["Span Total","Span 3"]},{"included":true,"id":"75fc05be-f1cc-4034-888f-41be4aae07a0","name":"Span 4","number":null,"fullName":"Span Total >> Span 4","fullPath":["Span Total","Span 4"]}],"allow":{"actOn":true,"edit":true,"delete":true,"copy":true,"check":true,"lockedFields":[]},"id":"a463319d-d0b1-410d-b606-b05cc281b9aa","asset":{"knwlType":{"id":"7165a2a0-c0d3-4153-a0fd-74ab98301b79","name":"Bridge","color":"#3EBCBD","icon":"bridge","attributeFields":[]},"comments":"toto","imageUrl":null,"id":"3dfcab0e-a265-4f8f-acd8-0d0ec0ac0cd3","name":"PARIS ROAD (HWY 2) OVERPASS, E.B.L","number":" 1 - 141/1"},"name":null,"frequency":365,"dueDate":"2017-11-20T10:22:12.2450575+01:00","knwlType":{"id":"a9c2b7dd-094a-468a-a6b4-6a6e2c2a18ac","name":"Regular OSIM","color":"#38E4DB","icon":"inspection","attributeFields":[]},"isActive":true}
		-- the procedure can be customized :
		--    - or using simple replace
					-- set @returnMasterJson=replace(@masterJson,'"name":null','"name":"default name for master"');
		--    - or rewrite the master object
					-- set @returnMasterJson='{"comments":null,"time":null,"assetComponents":[{"included":true,"id":"94d3cdd4-82ef-44f7-afd1-7c6a91805131","name":"Decks","number":null,"fullName":"Decks","fullPath":["Decks"]},{"included":true,"id":"4607e07f-1a5e-4a3c-b70e-ccafe81d6933","name":"Decks > Wearing surface","number":null,"fullName":"Decks >> Decks > Wearing surface","fullPath":["Decks","Decks > Wearing surface"]},{"included":true,"id":"983790f0-dd9b-4ffb-abb9-d5c476a4cc6e","name":"Decks > Deck top","number":null,"fullName":"Decks >> Decks > Deck top","fullPath":["Decks","Decks > Deck top"]},{"included":true,"id":"8dacd77a-29d9-4665-a7c1-32bef9a8f13f","name":"Decks > Soffit - Thin Slab","number":null,"fullName":"Decks >> Decks > Soffit - Thin Slab","fullPath":["Decks","Decks > Soffit - Thin Slab"]},{"included":true,"id":"62411211-e040-47a5-8c67-7bf4a4fbbf0f","name":"Decks > Soffit - Thin Slab","number":null,"fullName":"Decks >> Decks > Soffit - Thin Slab","fullPath":["Decks","Decks > Soffit - Thin Slab"]},{"included":true,"id":"ecfc3e27-8140-46e1-9433-9a82a82d8530","name":"Decks > Soffit - Thin Slab","number":null,"fullName":"Decks >> Decks > Soffit - Thin Slab","fullPath":["Decks","Decks > Soffit - Thin Slab"]},{"included":true,"id":"ea24bb8a-928b-45b1-b90a-a122f22bb7f3","name":"Approaches","number":null,"fullName":"Approaches","fullPath":["Approaches"]},{"included":true,"id":"ccce63fb-9917-4597-b561-08fa83fcfeb7","name":"Approaches > Wearing surface","number":null,"fullName":"Approaches >> Approaches > Wearing surface","fullPath":["Approaches","Approaches > Wearing surface"]},{"included":true,"id":"c9709a0c-7f0f-4314-8297-e0cb9f5bdd7d","name":"Joints","number":null,"fullName":"Joints","fullPath":["Joints"]},{"included":true,"id":"80beee55-70db-446c-abbc-782a1427b42e","name":"Joints > Armoring/retaining devices","number":null,"fullName":"Joints >> Joints > Armoring/retaining devices","fullPath":["Joints","Joints > Armoring/retaining devices"]},{"included":true,"id":"84167612-28c7-4a65-83ca-fdde6d7646d6","name":"Joints > Concrete end dams","number":null,"fullName":"Joints >> Joints > Concrete end dams","fullPath":["Joints","Joints > Concrete end dams"]},{"included":true,"id":"7f5cd234-e4cd-4802-b271-5dc3e204b040","name":"Joints > Seals/sealants","number":null,"fullName":"Joints >> Joints > Seals/sealants","fullPath":["Joints","Joints > Seals/sealants"]},{"included":true,"id":"689092f9-4db9-41fb-a77f-46238ee6cd97","name":"Barriers","number":null,"fullName":"Barriers","fullPath":["Barriers"]},{"included":true,"id":"e70e5952-e642-474f-ac8a-1acfdcc9b740","name":"Barriers > Barrier/Parapet Walls","number":null,"fullName":"Barriers >> Barriers > Barrier/Parapet Walls","fullPath":["Barriers","Barriers > Barrier/Parapet Walls"]},{"included":true,"id":"80742c48-1e5f-450d-b06b-99c5322bd165","name":"Barriers > Barrier/Parapet Walls","number":null,"fullName":"Barriers >> Barriers > Barrier/Parapet Walls","fullPath":["Barriers","Barriers > Barrier/Parapet Walls"]},{"included":true,"id":"a035de75-fd9c-4331-8a18-a20f7dc5f7e6","name":"Coatings","number":null,"fullName":"Coatings","fullPath":["Coatings"]},{"included":true,"id":"03362721-26fb-4f01-96e2-4c471fd90875","name":"Coatings > Structural Steel","number":null,"fullName":"Coatings >> Coatings > Structural Steel","fullPath":["Coatings","Coatings > Structural Steel"]},{"included":true,"id":"0562cc70-38f1-4841-8351-8847ac6541f2","name":"Coatings > Structural Steel","number":null,"fullName":"Coatings >> Coatings > Structural Steel","fullPath":["Coatings","Coatings > Structural Steel"]},{"included":true,"id":"a650c4b9-338b-4dbc-a380-4ae8737a394b","name":"Beams/MLE's","number":null,"fullName":"Beams/MLE's","fullPath":["Beams/MLE's"]},{"included":true,"id":"08284ebd-6ceb-4fdf-9571-28669056bce9","name":"Beams/MLE's > Girders","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Girders","fullPath":["Beams/MLE's","Beams/MLE's > Girders"]},{"included":true,"id":"62a50498-6587-49e2-ad06-8643eb579236","name":"Beams/MLE's > Girders","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Girders","fullPath":["Beams/MLE's","Beams/MLE's > Girders"]},{"included":true,"id":"7eebfabf-ff69-4b26-9830-3297d2fe9d37","name":"Beams/MLE's > Diaphragms","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Diaphragms","fullPath":["Beams/MLE's","Beams/MLE's > Diaphragms"]},{"included":true,"id":"358eae49-09cc-46b3-aed8-4adf1dd2f897","name":"Beams/MLE's > Diaphragms","number":null,"fullName":"Beams/MLE's >> Beams/MLE's > Diaphragms","fullPath":["Beams/MLE's","Beams/MLE's > Diaphragms"]},{"included":true,"id":"15951a57-6e6b-4ff7-8998-df2d3f2dd216","name":"Abutments","number":null,"fullName":"Abutments","fullPath":["Abutments"]},{"included":true,"id":"e47939fc-e3e9-4499-9b16-cb9900f42983","name":"Abutments > Abutment walls","number":null,"fullName":"Abutments >> Abutments > Abutment walls","fullPath":["Abutments","Abutments > Abutment walls"]},{"included":true,"id":"040765f8-9944-4bee-a934-386f62c405ac","name":"Abutments > Ballast walls","number":null,"fullName":"Abutments >> Abutments > Ballast walls","fullPath":["Abutments","Abutments > Ballast walls"]},{"included":true,"id":"7d6717be-269a-4a3e-8d73-997a32e7fad1","name":"Abutments > Bearings","number":null,"fullName":"Abutments >> Abutments > Bearings","fullPath":["Abutments","Abutments > Bearings"]},{"included":true,"id":"12c02b52-5a5b-4ccc-8de2-aa1a4dd9ac11","name":"Piers","number":null,"fullName":"Piers","fullPath":["Piers"]},{"included":true,"id":"103e2e7e-40cb-4c40-a6a3-416d2df1e583","name":"Piers > Shafts/columns/Pile Bents","number":null,"fullName":"Piers >> Piers > Shafts/columns/Pile Bents","fullPath":["Piers","Piers > Shafts/columns/Pile Bents"]},{"included":true,"id":"03f06642-362b-43c5-9592-08e7d556976f","name":"Piers > Caps","number":null,"fullName":"Piers >> Piers > Caps","fullPath":["Piers","Piers > Caps"]},{"included":true,"id":"a35bfb5e-0ef4-4bf9-b8d9-3e5a33858025","name":"Piers > Bearings","number":null,"fullName":"Piers >> Piers > Bearings","fullPath":["Piers","Piers > Bearings"]},{"included":true,"id":"3ced1a4b-b887-4b23-b40f-414c2c2834b1","name":"Retaining Walls","number":null,"fullName":"Retaining Walls","fullPath":["Retaining Walls"]},{"included":true,"id":"fbadcd05-3cd9-4e05-8ec2-b0b62ef6b444","name":"Retaining walls > Walls","number":null,"fullName":"Retaining Walls >> Retaining walls > Walls","fullPath":["Retaining Walls","Retaining walls > Walls"]},{"included":true,"id":"f7a16d82-f9f3-41ea-94f9-365101c0d807","name":"Foundations","number":null,"fullName":"Foundations","fullPath":["Foundations"]},{"included":true,"id":"a5f6f0fa-b756-4207-b9cb-5da3b7e36af8","name":"Foundations > Foundation (below ground level)","number":null,"fullName":"Foundations >> Foundations > Foundation (below ground level)","fullPath":["Foundations","Foundations > Foundation (below ground level)"]},{"included":true,"id":"dd7d9e08-cebd-4672-a570-659e0b180019","name":"Embankments & Streams","number":null,"fullName":"Embankments & Streams","fullPath":["Embankments & Streams"]},{"included":true,"id":"980e3fb6-f70c-4c65-9b50-79423c749f70","name":"Embankments & Streams > Embankments","number":null,"fullName":"Embankments & Streams >> Embankments & Streams > Embankments","fullPath":["Embankments & Streams","Embankments & Streams > Embankments"]},{"included":true,"id":"8a9491c9-5d3f-4971-81ae-8ee65bb6213a","name":"Embankments & Streams > Slope protection","number":null,"fullName":"Embankments & Streams >> Embankments & Streams > Slope protection","fullPath":["Embankments & Streams","Embankments & Streams > Slope protection"]},{"included":true,"id":"a4542cda-6c25-438d-87b7-e37162be5649","name":"Span Total","number":null,"fullName":"Span Total","fullPath":["Span Total"]},{"included":true,"id":"06d5507e-e16a-4034-ad0c-b67eeecfa232","name":"Span 1","number":null,"fullName":"Span Total >> Span 1","fullPath":["Span Total","Span 1"]},{"included":true,"id":"38b156e0-40d5-4f61-a589-f5d7873b7996","name":"Span 2","number":null,"fullName":"Span Total >> Span 2","fullPath":["Span Total","Span 2"]},{"included":true,"id":"19d04985-9ea4-4b11-aa8f-2eaf315d683c","name":"Span 3","number":null,"fullName":"Span Total >> Span 3","fullPath":["Span Total","Span 3"]},{"included":true,"id":"75fc05be-f1cc-4034-888f-41be4aae07a0","name":"Span 4","number":null,"fullName":"Span Total >> Span 4","fullPath":["Span Total","Span 4"]}],"allow":{"actOn":true,"edit":true,"delete":true,"copy":true,"check":true,"lockedFields":[]},"id":"a463319d-d0b1-410d-b606-b05cc281b9aa","asset":{"knwlType":{"id":"7165a2a0-c0d3-4153-a0fd-74ab98301b79","name":"Bridge","color":"#3EBCBD","icon":"bridge","attributeFields":[]},"comments":"toto","imageUrl":null,"id":"3dfcab0e-a265-4f8f-acd8-0d0ec0ac0cd3","name":"PARIS ROAD (HWY 2) OVERPASS, E.B.L","number":" 1 - 141/1"},"name":null,"frequency":365,"dueDate":"2017-11-20T10:22:12.2450575+01:00","knwlType":{"id":"a9c2b7dd-094a-468a-a6b4-6a6e2c2a18ac","name":"Regular OSIM","color":"#38E4DB","icon":"inspection","attributeFields":[]},"isActive":true}';

		-- include script here
		select @returnMasterJson;
	END TRY  
	
	BEGIN CATCH 
		RETURN 'Sql Error- Number:' + cast (ERROR_NUMBER() as nvarchar(max)) + ' ;Message:' + ERROR_MESSAGE();
	END CATCH;

END
GO
